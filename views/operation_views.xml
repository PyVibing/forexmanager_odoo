<?xml version="1.0" encoding="UTF-8"?>

<odoo>
    <!-- Form view of forexmanager.operation -->
    <record id="forexmanager_operation_form_view" model="ir.ui.view">
        <field name="name">ForexManager operation form view</field>
        <field name="model">forexmanager.operation</field>
        <field name="arch" type="xml">
            <form>
                <style>
                    .o_form_button_save.btn-light {
                        display: None;
                    }
                    
                    .o_field_x2many_list_row_add {
                        display: table-header-group;
                    }

                    .personal-card {
                        flex: 1 1 auto;
                        padding: 15px;
                        background-color: #ffffff;
                        border-radius: 8px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                        border-left: 4px solid #007bff;
                        margin-bottom: 15px;
                    }

                    .image-card {
                        flex: 1;
                        min-width: 300px;
                        padding: 15px;
                        background-color: #ffffff;
                        border-radius: 8px;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                        border-left: 4px solid #ffc107;
                        margin-bottom: 15px;
                    }

                    .section {
                        margin-bottom: 20px;
                        border-bottom: 1px solid #e0e0e0;
                        padding-bottom: 10px;
                    }

                    .section label {
                        font-weight: 600;
                    }

                    .field-row {
                        display: flex;
                        gap: 10px;
                        margin-top: 5px;
                        flex-wrap: wrap;
                    }

                    .field-input {
                        border: 1px solid #ccc;
                        border-radius: 4px;
                        padding: 4px 8px;
                        min-width: max-content;
                        height: 30px;
                    }

                    .flex-1 { flex: 1; }
                    .flex-2 { flex: 2; }
                    .min-150 { 
                        min-width: 150px; 
                    }

                    .section-title {
                        display: block;
                        font-size: 14px;
                        font-weight: 700;
                        color: #007bff;
                        margin-bottom: 8px;
                    }

                    .error-message {
                        display:flex; 
                        justify-content:center; 
                        width:100%;
                        background-color: #a72828ff;
                        border-radius:8px;
                        padding:12px 16px; 
                        display:flex; 
                        align-items:center; 
                        gap:10px;
                        color: #fcfcfcff; 
                        font-weight:600; 
                        font-size:16px;
                    }

                    label {
                        min-width: max-content;
                    }

                    .field-images {
                        display: flex;
                        flex-wrap: wrap;
                        gap: 10px;
                    }

                    .field-images field {
                        height: 150px;
                        width: 300px;
                        border: 1px solid #ccc;
                        border-radius: 4px;
                    }

                    #id_info .img-fluid {
                        width: 300px;
                        height: 150px;
                    }

                    .main-title {
                        display: block;
                        text-align: center;
                        font-size: 22px;
                        font-weight: 800;
                        color: #fff;
                        background: linear-gradient(135deg, #007bff, #0056b3);
                        padding: 10px 24px;
                        border-radius: 12px;
                        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
                        letter-spacing: 1px;
                        margin-bottom: 25px;
                    }
                </style>
                <sheet style="min-width: 100%;">
                    <div invisible="worksession_id or not desk_id">
                        <span class="error-message">No puedes operar en esta ventanilla. Primeramente debes iniciar sesión y realizar, si aún no lo has hecho, el arqueo de entrada.</span>
                    </div>
                    <div invisible="desk_id">
                        <span class="error-message">No has vinculado ninguna ventanilla. Ve al menú VINCULAR VENTANILLA y hazlo, para que puedas operar.</span>
                    </div>
                    <div invisible="not worksession_id or not desk_id or not (closing_session_check_started and not closing_session_check_ended)">
                        <span class="error-message">Tienes el arqueo de salida iniciado. Ya no puedes seguir operando.</span>
                    </div>
                    <div invisible="not worksession_id or (closing_session_check_started and not closing_session_check_ended)">
                        <h1 class="main-title">CAMBIO DE MONEDA</h1>
                        <notebook>
                            <page string="Moneda y cantidad">
                                <field name="calculation_ids" readonly="id">
                                    <list>
                                        <field name="name" width="300px;"/>
                                        <field name="payment_type" width="100"/>
                                        <field name="amount_received" string="A recibir" width="50"/>
                                        <field name="currency_source_id" string="Divisa" width="200"/>
                                        <field name="delivery_type" width="100"/>
                                        <field name="amount_delivered" string="A entregar" width="60"/>
                                        <field name="currency_target_id" string="Divisa" width="200"/>
                                        <field name="discount" width="80"/>
                                        <field name="operation_ref" width="50"/>
                                    </list>
                                </field>
                                <div>
                                    <field name="summary" readonly="1" widget="html" force_save="1"/>
                                </div>
                            </page>

                            <!-- Customer data -->
                            <page string="Datos del cliente">

                                <div style="display: flex; gap:20px; flex-wrap:wrap; width: 100%;">

                                    <!-- Main Info -->
                                    <div class="personal-card">
                                        
                                        <!-- Passport info -->
                                        <div class="section">
                                            <div class="section-title">INFORMACIÓN DEL PASAPORTE</div>

                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="ID_number"/>
                                                    <field name="ID_number" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="ID_type"/>
                                                    <field name="ID_type" options="{'no_create': True, 'no_open': True}" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="ID_country"/>
                                                    <field name="ID_country" options="{'no_create': True, 'no_open': True}" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="nationality"/>
                                                    <field name="nationality" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="ID_expiration"/>
                                                    <field name="ID_expiration" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                            </div>
                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <label for="search_ID"/>
                                                <field name="search_ID" readonly="search_ID or id"/>
                                                <field name="passport_id" invisible="1" force_save="1"/> <!-- We must have this field so we can use it in readonly and invisible  -->
                                            </div>
                                        </div>

                                        <!-- Name -->
                                        <div class="section">
                                            <div class="section-title">NOMBRE COMPLETO DEL CLIENTE</div>

                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="first_name_1"/>
                                                    <field name="first_name_1" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="first_name_2"/>
                                                    <field name="first_name_2" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="last_name_1"/>
                                                    <field name="last_name_1" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="last_name_2"/>
                                                    <field name="last_name_2" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Birth -->
                                        <div class="section">
                                            <div class="section-title">DATOS DE NACIMIENTO</div>

                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                                                    <label for="birth_country_id"/>
                                                    <field name="birth_country_id" options="{'no_create': True, 'no_open': True}" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="birth_date"/>
                                                    <field name="birth_date" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="sex">Sexo</label>
                                                    <field name="sex" class="field-input" readonly="passport_id or id" force_save="1"/>
                                                </div>
                                            </div>
                                        </div>


                                        <!-- Local address -->
                                        <div class="section">
                                            <div class="section-title">DIRECCIÓN LOCAL</div>

                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <div style="display: flex; flex-direction: column; flex: 2;">
                                                    <label for="street"/>
                                                    <field name="street" class="field-input"  readonly="id"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="number"/>
                                                    <field name="number" class="field-input" readonly="id"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="other"/>
                                                    <field name="other" class="field-input" readonly="id"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="postal_code"/>
                                                    <field name="postal_code" widget="char" class="field-input" readonly="id"/>
                                                </div>
                                            </div>

                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                                                    <label for="country_id"/>
                                                    <field name="country_id" options="{'no_create': True, 'no_open': True}" class="field-input" readonly="id"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                                                    <label for="province_id"/>
                                                    <field name="province_id" domain="[('country_id', '=', country_id)]" options="{'no_create': True, 'no_open': True}" class="field-input" readonly="id"/>
                                                </div>
                                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 150px;">
                                                    <label for="city"/>
                                                    <field name="city" class="field-input" readonly="id"/>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Contact -->
                                        <div class="section">
                                            <div class="section-title">DATOS DE CONTACTO</div>

                                            <div class="field-row" style="display: flex; gap: 10px;">
                                                <div style="display: flex; flex-direction: column; flex: 1;">
                                                    <label for="email"/>
                                                    <field name="email" class="field-input" style="width: 30%" readonly="id"/>
                                                </div>
                                            </div>                                            
                                        </div>

                                    </div>

                                    <!-- ID images -->
                                    <div id="id_info" class="image-card">
                                        
                                        <div style="margin-bottom: 20px; padding-bottom: 10px;">
                                            <label for="image_1" string="Imágenes del documento" style="font-weight:600; color:#ffc107;"/>
                                            <div class="field-images">
                                                <div style="display: flex; flex-direction: column;">
                                                    <field name="image_1" widget="image" readonly="id"/>
                                                    <div>
                                                        <label for="read_ID" string="Leer datos"/>
                                                        <field name="read_ID" readonly="id" style="margin-left: 10px;"/>
                                                    </div>
                                                </div>
                                                <div>
                                                    <field name="image_2" widget="image" readonly="id"/>
                                                </div>
                                                <div>
                                                    <field name="image_3" widget="image" readonly="id"/>
                                                </div>    
                                                <div>
                                                    <field name="image_4" widget="image" readonly="id"/>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            
                            </page>

                            <page string="Finalizar">
                                <div>
                                    <field name="diff_calc_summary" readonly="1" widget="html" force_save="1"/>
                                </div>
                                <div style="display: flex; align-items: center; margin-left: 200px; width: 300px; align-items: baseline;" 
                                        invisible="id or not diff_calc_summary">
                                    <h4 style="font-size: 14px; font-weight: 700; color: #007bff; margin: 0 10px 0 0;">
                                        TODO LISTO
                                    </h4>
                                    <field name="confirm"/>
                                    <div style="flex-grow: 1;"/>
                                    <button type="object" string="CONFIRMAR" class="btn btn-primary"/>
                                </div>
                            </page>
                        </notebook>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <record id="forexmanager_operation_list_view" model="ir.ui.view">
        <field name="name">Forexmanager operation list view</field>
        <field name="model">forexmanager.operation</field>
        <field name="arch" type="xml">
            <list delete="0" duplicate="0">
                <field name="id"/>
                <field name="name"/>
                <field name="worksession_id"/>
                <field name="user_id"/>
                <field name="desk_id" string="Ventanilla"/>
                <field name="opening_desk_id" string="Ventanilla de arqueo"/>
                <field name="date" string="Fecha"/>
                <field name="calculation_ids" string="Divisas cambiadas"/>
                <field name="passport_id" string="Cliente en BD"/>            
            </list>
        </field>
    </record>

    <record id="forexmanager_operation_search_view" model="ir.ui.view">
        <field name="name">Forexmanager operation search view</field>
        <field name="model">forexmanager.operation</field>
        <field name="arch" type="xml">
            <search>
                <field name="id"/>
                <field name="user_id"/>
                <field name="desk_id"/>
                <field name="worksession_id"/>
                <field name="opening_desk_id"/>
                <field name="calculation_ids"/>
                <field name="passport_id"/>
                <!-- Groups -->
                <filter name="group_by_worksession_id" context="{'group_by': 'worksession_id'}"/>
                <filter name="group_by_user_id" context="{'group_by': 'user_id'}"/>
                <filter name="group_by_desk_id" context="{'group_by': 'desk_id'}"/>
                <filter name="group_by_opening_desk_id" context="{'group_by': 'opening_desk_id'}"/>
                <filter name="group_by_date" context="{'group_by': 'date:day'}"/>
            </search>
        </field>
    </record>

    <!-- Action of forexmanager.operation -->
    <record id="forexmanager_new_operation_action" model="ir.actions.act_window">
        <field name="name">NUEVA OPERACIÓN</field>
        <field name="res_model">forexmanager.operation</field>
        <field name="view_mode">form</field>
    </record>

    <!-- For user - user history for current session -->
    <record id="forexmanager_user_history_operation_action" model="ir.actions.act_window">
        <field name="name">MI HISTORIAL</field>
        <field name="res_model">forexmanager.operation</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[("user_id", "=", uid), ("worksession_id.session_status", "=", "open"), ("worksession_id.session_type", "=", "checkin")]</field>
    </record>

    <!-- For admins - full history -->
    <record id="forexmanager_history_operation_action" model="ir.actions.act_window">
        <field name="name">HISTORIAL DE OPERACIONES</field>
        <field name="res_model">forexmanager.operation</field>
        <field name="view_mode">list,form</field>
        <field name="context">
            {"search_default_group_by_date": 1}
        </field>
    </record>
</odoo>